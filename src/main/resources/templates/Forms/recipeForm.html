<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="fragments/head :: header" />
    <title>ForgeMeals-Publica tu receta</title>
</head>


<body class="d-flex flex-column h-100 bg">
    <h1 style="align-self: center; margin-top: 20px; color:white;">Publica tu receta</h1>
    <div class="container" style="display: flex; justify-content: center; left: 0; right:0; top: 10vh; bottom:0">

        <div class="card bg-light" style="border-radius: 15px; height: fit-content; width:800px;">


            <div style="margin:20px">
                <form method="post" th:action="@{/addRecipe}">
                    <div class="mb-3" style="margin-left: 10px;">
                        <label for="name" class="form-label">Nombre receta:</label>
                        <input type="text" class="form-control" style="width: auto;" id="name"
                            aria-describedby="nameHelp" placeholder="Nombre receta" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ingredientes:</label>
                        <ul id="il">
                            <div id="ing">
                                <input type="text" class="form-control" id="ingredient"
                                    placeholder="Introducir Ingredientes" />
                                <ul class="dropdown-menu text-small" id="ingrList" aria-labelledby="dropdownUser1"
                                    style="">
                                    <li><a class="dropdown-item">Hola</a></li>
                                </ul>
                                <span class="input-group-addon"></span>
                                <input type="number" min="0" max="5000" id="cant_ing" class="form-control"
                                    placeholder="Introducir Cantidad" />
                                <hr class="my-4" style="width: 95%;">
                            </div>
                        </ul>
                        <div>
                            <button type="button" class="btn btn-primary" id="ai">+ Añadir Ingrediente</button>
                            <button type="button" class="btn btn-primary" id="ei" disabled>- Eliminar
                                Ingrediente</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Describe la receta:</label>
                        <textarea class="container" placeholder="Descripción de la receta" id="description"></textarea>

                    </div>
                    <div class="mb-3">
                        <label for="src" class="form-label">Sube la imagen de la receta:</label>
                        <input type="file" accept="image/png, image/jpeg" class="form-control" id="src">
                        <!--input type="text" class="form-control" id="src"-->
                    </div>
                    <button type="submit" id="sub_but" class="btn btn-primary">Subir</button>
                    <a href="/"> <button type="button" onclick="" class="btn btn-primary"
                            style="background-color:white;color:black;border-color: black;">Cancelar</button> </a>
                </form>
            </div>

        </div>
    </div>
    <img id="imag" style="visibility: hidden;" alt="careto a subir" />
    <!-- Bootstrap -->
    <script th:src="@{/js/bootstrap.bundle-5.1.3.js}" src="js/bootstrap.bundle-5.1.3.js"></script>

    <!-- Websockets -->
    <script th:src="@{/js/stomp.js}" src="js/stomp.js"></script>
    <!--script th:src="@{/js/iw.js}" src="js/iw.js"></script-->

    <script>

        let con = document.getElementById("il");
        let but = document.getElementById("ai");
        let but1 = document.getElementById("ei");
        but.onclick = a_ing;
        but1.onclick = e_ing;
        function a_ing() {
            but1.disabled = false;
            const cloned = document.getElementById("ing_orig").cloneNode(true)
            cloned.id = "ing";
            cloned.style.visibility = "visible";
            con.append(cloned);

        }
        function e_ing() {

            con.removeChild(con.lastElementChild);

            if (document.querySelectorAll("#ing").length === 1)
                but1.disabled = true;

        }
    </script>


    <script>

        let fileInput = document.getElementById("src");
        const sub_but = document.getElementById("sub_but");
        fileInput.onchange = (e) => { subImg(e) };
        function subImg(e) {
            let img = document.getElementById("imag");
            readImageFileData(fileInput.files[0], img);
        }
        sub_but.onclick = submit_recipe;
        function submit_recipe(e) {
            e.preventDefault();

            let ingNames = [];
            let qIngNames = document.querySelectorAll("#ingredient");
            qIngNames.forEach(e => ingNames.push(e.value));
            let ingCants = [];
            let qIngCants = document.querySelectorAll("#cant_ing");
            qIngCants.forEach(e => { ingCants.push(e.value) });


            let fileInput = document.getElementById("src");
            //console.log(img, fileInput);

            //let imageBlob = toBlob(fileInput.src);



            go("/user/addRecipe", 'POST', {
                description: document.getElementById("description").value,
                image: document.getElementById("imag").src,
                //image: imageBlob,
                name: document.getElementById("name").value,
                ingredientNames: ingNames,
                ingredientCant: ingCants
            })
                .then(d => console.log("Happy", d))
                .catch(e => console.log("sad", e))
        }


        function toBlob(dataurl) {
            let arr = dataurl.split(','),
                mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]),
                n = bstr.length,
                u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {
                type: mime
            });
        }


        function readImageFileData(file, targetImg) {

            // see https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL
            if (/\.(jpe?g|png|gif)$/i.test(file.name)) {
                let reader = new FileReader();
                reader.addEventListener("load", e => {
                    console.log(e);
                    targetImg.src = reader.result
                }, false);
                reader.readAsDataURL(file);
            } else {
                console.log("Not a good format: ", file.name);
            }
        }

        function readImageUrlData(url, targetImg) {
            return fetch(url)
                .then(response => response.blob())
                .then(blob => new Promise((resolve, reject) => {
                    const reader = new FileReader()
                    reader.onloadend = () => resolve(reader.result)
                    reader.onerror = reject
                    reader.readAsDataURL(blob)
                }))
                .then(data => targetImg.src = data);
        }



        function postImage(img, endpoint, name, filename) {
            // from https://stackoverflow.com/a/30470303/15472
            function toBlob(dataurl) {
                let arr = dataurl.split(','),
                    mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]),
                    n = bstr.length,
                    u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], {
                    type: mime
                });
            }
            let imageBlob = toBlob(img.src);
            let fd = new FormData();
            fd.append(name, imageBlob, filename);
            return go(endpoint, "POST", fd, {})
        }
    </script>


</body>
<div id="ingred" th:attr="ingredientes=${ingredients}"></div>
<div id="ing_orig" style="visibility: hidden;">
    <input type="text" class="form-control" id="ingredient" placeholder="Introducir Ingredientes" />
    <ul class="dropdown-menu text-small" id="ingrList" aria-labelledby="dropdownUser1" style="">
        <li><a class="dropdown-item">Hola</a></li>
    </ul>
    <span class="input-group-addon"></span>
    <input type="number" min="0" max="5000" id="cant_ing" class="form-control" placeholder="Introducir Cantidad" />
    <hr class="my-4" style="width: 95%;">
</div>



</html>